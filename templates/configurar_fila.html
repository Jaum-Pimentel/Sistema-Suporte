{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <div class="notify-section">
        <div class="notify-box">
            <div class="notify-info">
                <h4>Lembrete de Início de Dia</h4>
                <p>Clique no botão para enviar uma notificação para o atendente que está atualmente na vez na fila.</p>
            </div>
            <form method="POST" action="{{ url_for('notificar_atendente_atual') }}" style="margin: 0;">
                <button type="submit" class="btn btn-notify">
                    <i class="fa-solid fa-bell"></i> Notificar Atendente Atual
                </button>
            </form>
        </div>
    </div>
    <form class="config-form" method="POST" action="{{ url_for('configurar_fila') }}">
    <div class="config-container">
        <div class="config-column">
            <h3>Usuários Disponíveis</h3>
            <ul class="user-list" id="available-users-list">
                {% for user in all_users %}
                    {% if user.id not in queue_user_ids %}
                    <li class="user-card" data-user-id="{{ user.id }}">
                        <div class="user-card-info">
                            <span class="user-name">{{ user.name }}</span>
                            <small>{{ user.username }}</small>
                        </div>
                        <button type="button" class="move-btn add" title="Adicionar à fila">→</button>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="config-column">
            <h3>Fila Ativa (Arraste para ordenar)</h3>
            <ul class="user-list" id="active-queue-list">
                {% for member in queue_members %}
                <li class="user-card" data-user-id="{{ member.user.id }}">
                       <button type="button" class="move-btn remove" title="Remover da fila">←</button>
                    <div class="user-card-info">
                        <span class="user-name">{{ member.user.name }}</span>
                        <small>{{ member.user.username }}</small>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="config-column">
            <h3>Detalhes do Usuário</h3>
            <div id="details-form">
                <div class="details-placeholder">
                    <p>Clique em um usuário para ver os detalhes.</p>
                </div>
                <div class="details-content hidden">
                    <h4 id="details-user-name"></h4>
                    <div class="input-group">
                        <label for="discord_id">ID do Usuário do Discord</label>
                        <input type="text" id="discord_id" name="discord_id_details">
                    </div>
                    <div class="input-group">
                        <label for="lunch_start">Início do Almoço</label>
                        <input type="time" id="lunch_start" name="lunch_start_details">
                    </div>
                    <div class="input-group">
                        <label for="lunch_end">Fim do Almoço</label>
                        <input type="time" id="lunch_end" name="lunch_end_details">
                    </div>
                    <input type="hidden" id="details_user_id" name="details_user_id">
                    
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="queue-order-input" name="queue_order">
</form>
{% endblock %}

{% block scripts %}
{{ super() }} <script src="{{ url_for('static', filename='js/sortable.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const availableList = document.getElementById('available-users-list');
    const activeList = document.getElementById('active-queue-list');
    const queueOrderInput = document.getElementById('queue-order-input');
    const form = document.querySelector('.config-form');
    
    // Elementos do formulário de detalhes
    const detailsContent = document.querySelector('.details-content');
    const detailsPlaceholder = document.querySelector('.details-placeholder');
    const detailsUserName = document.getElementById('details-user-name');
    const discordIdInput = document.getElementById('discord_id');
    const lunchStartInput = document.getElementById('lunch_start');
    const lunchEndInput = document.getElementById('lunch_end');
    const detailsUserIdInput = document.getElementById('details_user_id');

    let selectedUserId = null; // Guarda o ID do usuário atualmente selecionado nos detalhes

    // Função para buscar e exibir os detalhes do usuário
    function fetchUserDetails(userId, userName) {
        fetch(`/get_user_details/${userId}`)
            .then(response => response.json())
            .then(data => {
                detailsUserName.textContent = userName;
                discordIdInput.value = data.discord_id || '';
                lunchStartInput.value = data.lunch_start || '';
                lunchEndInput.value = data.lunch_end || '';
                detailsUserIdInput.value = userId; // Guarda o ID no input hidden
                
                // Mostra a seção de detalhes e esconde o placeholder
                detailsPlaceholder.classList.add('hidden');
                detailsContent.classList.remove('hidden');
            })
            .catch(error => {
                console.error("Erro ao buscar detalhes do usuário:", error);
                // Opcional: Mostrar mensagem de erro para o usuário
                detailsPlaceholder.textContent = "Erro ao carregar detalhes.";
                detailsPlaceholder.classList.remove('hidden');
                detailsContent.classList.add('hidden');
            });
    }

    // Função para marcar visualmente um usuário como selecionado
    function selectUserCard(userCard) {
        // Remove a seleção de qualquer outro card
        document.querySelectorAll('.user-card.selected').forEach(card => card.classList.remove('selected'));
        // Adiciona a classe ao card clicado
        userCard.classList.add('selected');
    }
    
    // Delegação de evento para cliques nas listas de usuários
    document.querySelector('.config-container').addEventListener('click', function(event) {
        const userCard = event.target.closest('.user-card');
        if (!userCard) return; // Sai se o clique não foi em um card

        const target = event.target;
        const userId = userCard.dataset.userId;
        const userName = userCard.querySelector('.user-name').textContent;
        
        // Clicar no botão de adicionar (→)
        if (target.classList.contains('add')) {
            activeList.appendChild(userCard); // Move o card para a fila ativa
             // Opcional: Se o usuário movido era o selecionado, limpa os detalhes
             if (selectedUserId === userId) clearDetails();
        } 
        // Clicar no botão de remover (←)
        else if (target.classList.contains('remove')) {
            availableList.appendChild(userCard); // Move o card para disponíveis
             // Opcional: Se o usuário movido era o selecionado, limpa os detalhes
             if (selectedUserId === userId) clearDetails();
        }
        // Clicar em qualquer outra parte do card (para ver detalhes)
        else {
            selectUserCard(userCard); // Marca visualmente
            selectedUserId = userId; // Guarda o ID selecionado
            fetchUserDetails(userId, userName); // Busca e mostra os detalhes
        }
    });

    // Função para limpar o formulário de detalhes
    function clearDetails() {
         detailsUserName.textContent = '';
         discordIdInput.value = '';
         lunchStartInput.value = '';
         lunchEndInput.value = '';
         detailsUserIdInput.value = ''; // Limpa o ID escondido
         selectedUserId = null; // Reseta o ID selecionado
         detailsPlaceholder.classList.remove('hidden'); // Mostra placeholder
         detailsContent.classList.add('hidden'); // Esconde conteúdo
         document.querySelectorAll('.user-card.selected').forEach(card => card.classList.remove('selected')); // Remove seleção visual
    }

    // Ativa o "arrastar e soltar" para reordenar a Fila Ativa
    new Sortable(activeList, {
        animation: 150,
        ghostClass: 'card-ghost', // Classe para o "fantasma" do item sendo arrastado
        // Opcional: onEnd pode ser usado para feedback visual ou lógica extra ao soltar
        // onEnd: function (evt) {
        //     console.log('Ordem da fila alterada.');
        // }
    });

    // Antes de enviar o formulário principal, atualiza o input escondido com a ordem da fila
    form.addEventListener('submit', function (event) {
        const userItemsInQueue = activeList.querySelectorAll('.user-card');
        const userIdsInOrder = Array.from(userItemsInQueue).map(li => li.dataset.userId);
        queueOrderInput.value = userIdsInOrder.join(',');

        // Os detalhes (discord_id_details, lunch_start_details, etc.) já estão
        // nos inputs dentro da coluna 3 e serão enviados junto com o form.
        // O `details_user_id` hidden garante que o backend saiba a qual usuário
        // esses detalhes pertencem.
    });
});
</script>
{% endblock %}